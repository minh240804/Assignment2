@page
@model Presentation.Pages.TagManagement.IndexModel
@{
    ViewData["Title"] = "Tag Management";
}

<h2>Tag Management</h2>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<button id="btnCreate" class="btn btn-success mb-3"
        data-url="@Url.Page("/TagManagement/Form")">
    + New Tag
</button>

<table class="table table-bordered table-striped">
    <thead class="table-light">
        <tr>
            <th>Name</th>
            <th>Note</th>
            <th style="width:140px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var tag in Model.Tags)
        {

            <tr data-tag-id="@tag.TagId">

                <td>@tag.TagName</td>
                <td>@tag.Note</td>
                <td>
                    <button class="btn btn-sm btn-warning btn-edit"
                            data-url="@Url.Page("/TagManagement/Form", new { id = tag.TagId })">
                        Edit
                    </button>
                    <form asp-page-handler="Delete" asp-route-id="@tag.TagId" method="post"
                          onsubmit="return confirm('Are you sure you want to delete this article?');"
                          style="display: inline;">
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </form>
                </td>
            </tr>
        }
        @if (!Model.Tags.Any())
        {
            <tr><td colspan="3" class="text-center">No tags found.</td></tr>
        }
    </tbody>
</table>

<div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content"></div>
    </div>
</div>


<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
            <div class="modal-body">Are you sure you want to delete this tag? This action cannot be undone.</div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-danger" id="btnConfirmDelete">Confirm Delete</button></div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
                      function showCreateForm() {
            const url = $('#btnCreate').data('url');
            $('#formModal .modal-content').load(url, function () {
                $('#formModal').modal('show');
            });
        }


        function showEditForm(id) {
            $('#formModal .modal-content').load('/TagManagement/Form?id=' + id, function () {
                $('#formModal').modal('show');
            });
        }

    </script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/notificationHub")
            .build();
        connection.on("TagDeleted", function (tagid,tagName) {
            toastr.info(`Tag "${tagName}" has been deleted.`);
             const rowToRemove = [...document.querySelectorAll("table tbody tr")]
                .find(row => row.children[0].innerText.trim() === tagName);

            if (rowToRemove) {
                rowToRemove.remove();
            }

            // ✅ Kiểm tra nếu không còn tag nào
            const tbody = document.querySelector("table tbody");
            if (tbody && tbody.children.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="text-center">No tags found.</td></tr>`;
            }
        });

        connection.start().catch(err => console.error(err.toString()));
    </script>
    <script>
        $(document).ready(function () {
            // Khi bấm nút "New Tag"
            $('#btnCreate').click(function () {
                showCreateForm();
            });

            // Khi bấm nút "Edit"
            $('.btn-edit').click(function () {
                const url = $(this).data('url');
                $('#formModal .modal-content').load(url, function () {
                    $('#formModal').modal('show');
                });
            });
        });
    </script>
    <script>
                     connection.on("TagCreated", function (tagId, tagName, note) {
            toastr.success(`New tag "${tagName}" created.`);

            const tbody = document.querySelector("table tbody");

            const newRow = document.createElement("tr");
            newRow.setAttribute("data-tag-id", tagId);
            newRow.innerHTML = `
                <td>${tagName || ""}</td>
                <td>${note || ""}</td>
                <td>
                    <button class="btn btn-sm btn-warning btn-edit" data-url="/TagManagement/Form?id=${tagId}">Edit</button>
                    <form method="post" action="/TagManagement/Index?handler=Delete&id=${tagId}" class="d-inline">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </td>
            `;

            const emptyRow = tbody.querySelector("tr td[colspan]");
            if (emptyRow) emptyRow.parentElement.remove();

            tbody.appendChild(newRow);

                const newEditBtn = newRow.querySelector('.btn-edit');
        if (newEditBtn) {
            newEditBtn.addEventListener('click', function () {
                const url = this.getAttribute('data-url');
                $('#formModal .modal-content').load(url, function () {
                    $('#formModal').modal('show');
                });
            });
        }
        });



        connection.on("TagUpdated", function (tagId, tagName, note) {
             console.log("TagUpdated received:", tagId, tagName, note);
             const row = document.querySelector(`tr[data-tag-id="${tagId}"]`);
            if (!row) return;

            row.children[0].innerText = tagName;
            row.children[1].innerText = note;

            toastr.info(`Tag "${tagName}" updated.`);
        });

    </script>
}


