@page
@model Presentation.Pages.CategoryManagement.IndexModel

@{
    ViewData["Title"] = "Index";
}

<h2>Category Management</h2>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<form method="get" class="mb-3 d-flex">
    <input type="text" name="search" class="form-control me-2" placeholder="Search..." value="@Model.Search" />

    <select name="active" class="form-select me-2" style="max-width:150px;">
        <option value="">All</option>
        <option value="true" selected="@(Model.Status?.ToString() == "True" ? "selected" : null)">Active</option>
        <option value="false" selected="@(Model.Status?.ToString() == "False" ? "selected" : null)">Inactive</option>
    </select>

    <button class="btn btn-primary">Filter</button>
</form>

<a href="javascript:void(0)" class="btn btn-primary" onclick="showCreateForm()">Create New</a>

<table class="table table-bordered">
    <thead>
        <tr>
            <th>Name</th>
            <th>Description</th>
            <th>Parent</th>
            <th>Status</th>
            <th style="width:140px;">Actions</th>
        </tr>
    </thead>
    <tbody>
        @if (Model.Categories == null || !Model.Categories.Any()  )
        {
            <tr>
                <td colspan="5" class="text-center">No categories found.</td>
            </tr>
        }
        else
        {
            @foreach (var c in Model.Categories)
            {
                <tr>
                    <td id="index_@(c.CategoryId - 1)">@c.CategoryName</td>
                    <td>@c.CategoryDesciption</td>
                    <td>@(c.ParentCategory?.CategoryName ?? "-")</td>
                    <td>@((c.IsActive ?? false) ? "Active" : "Inactive")</td>
                    <td>
                        <a href="javascript:void(0)" class="btn btn-sm btn-primary"
                           onclick="showEditForm(@c.CategoryId)">Edit</a>
                        <form method="post" asp-page-handler="Delete" asp-route-id="@c.CategoryId" class="d-inline">
                            <button type="submit"
                                    class="btn btn-sm btn-danger"
                                    onclick="return confirm('Are you sure you want to delete this category?');">
                                Delete
                            </button>
                        </form>
                    </td>
                </tr>
            }
        }
        

        
    </tbody>
</table>

@if (Model.TotalPages > 1)
{
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <!-- Previous -->
            <li class="page-item @(Model.CurrentPage <= 1 ? "disabled" : "")">
                <a class="page-link"
                   asp-page="./Index"
                   asp-route-currentPage="@(Model.CurrentPage - 1)"
                   asp-route-search="@Model.Search"
                   asp-route-status="@Model.Status">
                    Previous
                </a>
            </li>

            @{
                int start = Math.Max(1, Model.CurrentPage - 2);
                int end = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
            }
            @for (int i = start; i <= end; i++)
            {
                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                    <a class="page-link"
                       asp-page="./Index"
                       asp-route-currentPage="@i"
                       asp-route-search="@Model.Search"
                       asp-route-status="@Model.Status">
                        @i
                    </a>
                </li>
            }

            <!-- Next -->
            <li class="page-item @(Model.CurrentPage >= Model.TotalPages ? "disabled" : "")">
                <a class="page-link"
                   asp-page="./Index"
                   asp-route-currentPage="@(Model.CurrentPage + 1)"
                   asp-route-search="@Model.Search"
                   asp-route-status="@Model.Status">
                    Next
                </a>
            </li>
        </ul>
    </nav>
}

<!-- Modal for popup form -->
<div id="formModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Form content will be loaded here -->
        </div>
    </div>
</div>

@section Scripts {
 <script>
        function showCreateForm() {
            $('#formModal .modal-content').load('/CategoryManagement/Form?IsModal=true', function() {
                $('#formModal').modal('show');
                $.validator.unobtrusive.parse('#formModal');
            });
        }

        function showEditForm(id) {
            $('#formModal .modal-content').load('/CategoryManagement/Form/' + id + '?IsModal=true', function() {
                $('#formModal').modal('show');
                $.validator.unobtrusive.parse('#formModal');
            });
        }

        // 🔴 AJAX Submit Handler for Modal Forms
        $(document).on('submit', '#formModal form[data-modal="true"]', function(e) {
            e.preventDefault();
            const $form = $(this);

            // Client-side validation
            if (!$form.valid()) return;

            // Show loading state
            const $submitBtn = $form.find('button[type="submit"]');
            const originalText = $submitBtn.html();
            $submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Saving...');

            $.ajax({
                url: $form.attr('action'),
                type: 'POST',
                data: $form.serialize(),
                success: function(res, status, xhr) {
                    const ct = xhr.getResponseHeader('Content-Type') || '';

                    // ✅ Success (JSON response)
                    if (ct.includes('application/json') && res && res.success) {
                        $('#formModal').modal('hide');
                        location.reload(); // Reload to show updated list
                        return;
                    }

                    // ❌ Validation Error (HTML response)
                    $('#formModal .modal-content').html(res);
                    $.validator.unobtrusive.parse('#formModal');
                },
                error: function(xhr) {
                    const errorHtml = xhr.responseText || '<div class="p-3 text-danger">An unexpected error occurred.</div>';
                    $('#formModal .modal-content').html(errorHtml);
                    $.validator.unobtrusive.parse('#formModal');
                },
                complete: function() {
                    $submitBtn.prop('disabled', false).html(originalText);
                }
            });
        });

        // Clear modal on hide
        $('#formModal').on('hidden.bs.modal', function() {
            $(this).find('.modal-content').html('');
        });
    </script>

    <script>window.isCategoryList = true;</script>
}